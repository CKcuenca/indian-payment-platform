# 🔐 商户密钥管理系统设计方案

## 📋 功能概述

为下游商户（游戏公司、其他支付商）提供完整的密钥管理功能，确保API调用的安全性和可管理性。

## 🎯 核心功能

### 1. 密钥展示页面
```
┌─────────────────────────────────────────────────────────┐
│ 🔑 API密钥管理                                            │
├─────────────────────────────────────────────────────────┤
│ 商户信息                                                  │
│ • 商户号: MERCHANT_MEWZV8HV                              │
│ • 商户名称: 游戏公司A                                      │
│ • 账户状态: 激活 🟢                                      │
├─────────────────────────────────────────────────────────┤
│ API凭据                                                  │
│ • API Key: pk_0u3x5ivp9mewzv8hv                        │
│   [复制] [显示二维码]                                      │
│                                                         │
│ • Secret Key: sk_****************hv                    │
│   [显示完整密钥] [复制] [隐藏]                              │
├─────────────────────────────────────────────────────────┤
│ 操作                                                     │
│ [重新生成密钥] [下载配置文件] [查看使用示例]                 │
├─────────────────────────────────────────────────────────┤
│ 安全信息                                                 │
│ • 最后更新: 2025-09-11 12:30:15                        │
│ • 历史版本: 3个已废弃的密钥                               │
│ • 使用次数: 今日1,234次 / 本月45,678次                   │
└─────────────────────────────────────────────────────────┘
```

### 2. 重新生成密钥流程
```
点击"重新生成密钥" 
    ↓
[安全验证对话框]
┌─────────────────────────┐
│ ⚠️ 重新生成API密钥        │
├─────────────────────────┤
│ 请输入您的登录密码：       │
│ [password_input]        │
│                        │
│ 重新生成原因：            │
│ □ 密钥泄露              │
│ □ 定期更新              │
│ □ 安全升级              │
│ □ 其他: [text_input]    │
│                        │
│ ⚠️ 注意：新密钥生成后，    │
│    旧密钥将在24小时后失效  │
│                        │
│ [取消] [确认生成]        │
└─────────────────────────┘
    ↓
[新密钥展示]
┌─────────────────────────┐
│ ✅ 密钥重新生成成功       │
├─────────────────────────┤
│ 新API Key:             │
│ pk_new_key_here        │
│ [复制]                 │
│                        │
│ 新Secret Key:          │
│ sk_new_secret_here     │
│ [复制] [显示二维码]      │
│                        │
│ ⏰ 旧密钥失效时间：       │
│ 2025-09-12 12:30:15    │
│                        │
│ [下载新配置] [关闭]      │
└─────────────────────────┘
```

### 3. 使用示例页面
```
┌─────────────────────────────────────────────────────────┐
│ 📖 API使用示例和文档                                      │
├─────────────────────────────────────────────────────────┤
│ [代收支付] [代付提现] [查询余额] [订单查询] [签名算法]      │
├─────────────────────────────────────────────────────────┤
│ 代收支付示例                                             │
│                                                         │
│ 请求URL: POST https://cashgit.com/api/pay               │
│                                                         │
│ 请求参数:                                               │
│ {                                                       │
│   "appid": "MERCHANT_MEWZV8HV",                        │
│   "orderid": "GAME_ORDER_123456789",                   │
│   "amount": "100.00",                                  │
│   "currency": "INR",                                   │
│   "subject": "游戏币充值",                               │
│   "customer_phone": "9876543210",                      │
│   "notify_url": "https://your-game.com/notify",        │
│   "timestamp": "1757574992",                           │
│   "sign": "generated_signature"                        │
│ }                                                       │
│                                                         │
│ [复制代码] [在线测试] [下载SDK]                           │
└─────────────────────────────────────────────────────────┘
```

## 🛠 技术实现

### 数据库结构扩展
```javascript
// merchants 集合添加字段
{
  merchantId: 'MERCHANT_MEWZV8HV',
  apiKey: 'pk_generated_key',      // 公钥
  secretKey: 'sk_generated_key',   // 私钥
  
  // 安全管理
  security: {
    keyStatus: 'ACTIVE',           // ACTIVE, DISABLED, EXPIRED
    lastKeyUpdate: new Date(),     // 最后更新时间
    keyUpdateBy: 'user_id',        // 更新操作者
    keyHistory: [                  // 历史密钥记录
      {
        apiKey: 'old_key',
        secretKey: 'old_secret',
        deprecatedAt: new Date(),
        reason: 'KEY_REGENERATION'
      }
    ],
    usage: {
      dailyCount: 1234,            // 今日调用次数
      monthlyCount: 45678,         // 本月调用次数
      lastUsed: new Date()         // 最后使用时间
    }
  }
}
```

### API端点
```javascript
// 商户密钥管理API
GET  /api/merchant/keys           // 获取密钥信息
POST /api/merchant/keys/regenerate // 重新生成密钥
GET  /api/merchant/keys/download  // 下载配置文件
GET  /api/merchant/keys/examples  // 获取使用示例
POST /api/merchant/keys/validate  // 验证密钥有效性
```

## 🔒 安全措施

### 1. 访问控制
- 只有商户本人可以查看和管理自己的密钥
- 管理员可以禁用/启用商户密钥
- 所有密钥操作都需要身份验证

### 2. 密钥保护
- Secret Key 在界面上默认脱敏显示
- 提供"显示完整密钥"功能，需要额外验证
- 密钥历史记录保留，但旧密钥会失效

### 3. 操作审计
- 记录所有密钥操作日志
- 包括生成、查看、下载、禁用等操作
- 记录操作者和操作时间

### 4. 使用监控
- 统计API调用次数
- 监控异常使用模式
- 支持设置调用频率限制

## 📱 用户体验设计

### 1. 友好提示
- 密钥生成后提供保存提醒
- 旧密钥失效时间明确显示
- 提供密钥使用状态实时反馈

### 2. 便捷功能
- 一键复制密钥
- 二维码显示密钥（便于移动端）
- 配置文件下载
- 多语言代码示例

### 3. 安全警告
- 密钥泄露风险提醒
- 定期更新密钥建议
- 异常使用监控告警

## 🚀 实施优先级

### 阶段1 - 核心功能 (立即实施)
1. 基础密钥显示页面
2. 密钥重新生成功能
3. 基本的安全验证

### 阶段2 - 增强功能 (1周内)
1. 使用示例和文档页面
2. 配置文件下载功能
3. 使用统计功能

### 阶段3 - 高级功能 (2周内)
1. API调用监控
2. 异常检测和告警
3. 批量密钥管理（管理员）

## 💡 其他建议

1. **密钥轮换策略**: 建议商户定期（如3个月）更新密钥
2. **多环境支持**: 可以为同一商户提供测试和生产环境的不同密钥
3. **权限分级**: 大商户可能需要多个子账号，每个子账号有不同权限
4. **集成webhook**: 密钥变更时自动通知商户
5. **SDK提供**: 为主流编程语言提供SDK，简化集成

这个密钥管理系统将大大提升你的支付平台的专业性和安全性！